# https://taskfile.dev
# run task from the root with "task {mytask} -t /build/Taskfile.yaml"

version: '3'

interval: '1000ms'

tasks:

  build_website:
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - rm -rf ./website
      - mkdir -p ./website
      - cp -R ./web/static/** ./website/
      - GOARCH=wasm GOOS=js go build -o ./website/static/spa.wasm ./web/wasm/main.go
      - go build -o ./website/linkerpod ./cmd/linkerpod/linkerpod.go

  unit_test:
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - go test -cover -race ./pkg/...
      - GOARCH=wasm GOOS=js go test -cover ./web/...

  dev_wasm:
    dir: '{{.USER_WORKING_DIR}}'
    sources: 
      - "web/wasm/main.go"
    cmds: 
      - GOARCH=wasm GOOS=js go build -o ./tmp/website/spa.wasm ./web/wasm/main.go

  dev_components:
    dir: '{{.USER_WORKING_DIR}}'
    sources: 
      - "web/component/**/*"
      - "pkg/icecake/**/*"
    cmds: 
      - GOARCH=wasm GOOS=js go build -o ./tmp/website/spa.wasm ./web/wasm/main.go

  dev_static: 
    dir: '{{.USER_WORKING_DIR}}'
    sources: 
      - "./web/static/**/*"
    cmds: 
      - mkdir -p ./tmp/website
      - cp -R ./web/static/** ./tmp/website/

  # launch it with --watch 
  dev_front:
    dir: '{{.USER_WORKING_DIR}}'
    deps: 
      - task: dev_static
      - task: dev_components
      - task: dev_wasm

  dev_back:
    dir: '{{.USER_WORKING_DIR}}'
    ignore_error: true
    cmds: 
      - go run ./cmd/linkerpod/linkerpod.go --env=./configs/dev
